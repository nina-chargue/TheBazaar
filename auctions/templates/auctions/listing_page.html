{% extends "auctions/layout.html" %}
{% load static %}

{% block body %}
<div class="product-page">

  <!-- MAIN CARD -->
  <div class="product-card">

    <!-- LEFT: IMAGE GALLERY -->
    <div class="product-gallery">
      {% if listing.images.all %}
        <div class="main-image-container">
          <img id="mainImage"
               src="{{ listing.images.first.image.url }}"
               alt="{{ listing.title }}"
               class="main-image">
        </div>

        <div class="thumbnail-row">
          {% for image in listing.images.all %}
            <button type="button"
                    class="thumb {% if forloop.first %}active{% endif %}"
                    onclick="changeMainImage(this.querySelector('img'))">
              <img src="{{ image.image.url }}" alt="{{ listing.title }}">
            </button>
          {% endfor %}
        </div>
      {% else %}
        <div class="main-image-container placeholder">
          <span>No image</span>
        </div>
      {% endif %}
    </div>

    <!-- RIGHT: PRODUCT INFO -->
    <div class="product-info">

      <div class="product-header">
        <div>
          <div class="creator-line">Seller: <a href="{% url 'creator_profile' listing.creator.id %}">{{ listing.creator }}</a></div>
          <h1 class="product-title">{{ listing.title }}</h1>
        </div>

        {% if user.is_authenticated and user == listing.creator %}
          <form action="{% url 'edit_listing' listing_id=listing.id %}" method="post">
            {% csrf_token %}
            <button class="btn-outline" type="submit">Edit</button>
          </form>
        {% endif %}
      </div>

      <div class="product-description">
        {{ listing.description }}
      </div>

      <!-- PRICE -->
      <div class="product-price">
        {% if no_current_bid %}
          ${{ listing.starting_bid|floatformat:"2" }}
        {% else %}
          ${{ listing.current_bid }}
        {% endif %}
      </div>

      <!-- MESSAGES -->
      {% if messages %}
        <div class="message-stack">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- ACTIONS -->
      <div class="product-actions">

        <!-- WATCHLIST -->
        {% if user.is_authenticated %}
          <form action="{% if in_watchlist %}{% url 'remove_from_watchlist' listing_id=listing.id %}{% else %}{% url 'add_to_watchlist' listing_id=listing.id %}{% endif %}"
                method="post">
            {% csrf_token %}
            <input type="hidden" name="listing_id" value="{{ listing.id }}">
            <button class="btn-outline full" type="submit">
              {% if in_watchlist %}Remove from{% else %}Add to{% endif %} Watchlist
            </button>
          </form>
        {% endif %}

        <!-- BIDDING / CLOSE -->
        {% if user.is_authenticated %}
          {% if user != listing.creator %}
            {% if not has_won %}
              <form class="bid-row" action="{% url 'place_bid' listing_id=listing.id %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                <input class="bid-input" type="number" name="bid" placeholder="Enter bid" step="0.01" required>
                <button class="btn-primary" type="submit">Place bid</button>
              </form>
            {% else %}
              <div class="notice">You've won this auction!</div>
            {% endif %}
          {% else %}
            {% if listing.state == 'Active' %}
              <div class="notice">
                {% if no_current_bidder %}
                  <b>No current bidder</b>
                {% else %}
                  Current Bidder: <b>{{ listing.current_bidder.username }}</b>
                {% endif %}
              </div>

              <form action="{% url 'close_auction' listing_id=listing.id %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                <button class="btn-primary full" type="submit">Close Auction</button>
              </form>
            {% else %}
              <div class="notice">Auction is closed.</div>
            {% endif %}
          {% endif %}
        {% else %}
          <div class="notice">
            <a href="{% url 'login' %}">Log in</a> to place a bid or add to watchlist.
          </div>
        {% endif %}

      </div>

      <!-- META DETAILS -->
      <div class="product-meta">
        <div><b>Category:</b> {{ listing.category }}</div>
        <div><b>Created:</b> {{ listing.date_created }}</div>
        <div><b>Status:</b> {{ listing.state }}</div>
      </div>

    </div>
  </div>

  <!-- COMMENTS -->
  <div class="product-comments">
    <div class="comments_section">
      <h3>Comments</h3>

      {% for comment in listing.comments.all %}
        <div class="comments-section">
          <div class="comment">{{ comment.content }}</div>
          <div class="user-comment">{{ comment.commenter }} - {{ comment.timestamp }}</div>
        </div>
        <hr>
      {% empty %}
        <p>Be the first one to comment!</p>
      {% endfor %}

      {% if user.is_authenticated %}
        {% if listing.state == 'Closed' %}
          <p>Comments are closed as this auction has ended.</p>
        {% else %}
          <form action="{% url 'add_comment' listing_id=listing.id %}" method="post">
            {% csrf_token %}
            <div class="commenter-section">
              <textarea class="form-control" name="content" placeholder="Add a comment" required></textarea>
            </div>
            <button class="btn-primary full" type="submit">Add Comment</button>
          </form>
        {% endif %}
      {% else %}
        <p>Please <a href="{% url 'login' %}">log in</a> to add comments.</p>
      {% endif %}
    </div>
  </div>

</div>

<script src="{% static 'auctions/js/listing_page.js' %}"></script>
{% endblock %}